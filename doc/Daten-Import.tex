%\usepackage{listings}
\subsubsection{Import der Daten}
Um die Verwendung von der NoSQL Datenbank HBase und das Programmiermodel MapReduce zu demonstrieren greifen wir auf die frei verfügbare Liste der Daten zu, die millionen Datensätze zu den unterschiedlichen Liedern enthält. Die Datensätze werden von dem Anbieter http://labrosa.ee.columbia.edu/millionsong/pages/getting-dataset bereitgestellt und und sind in dem Verzeichnis "/data/team6/MillionSongSubset/data" in den *.h5 Dateien zu finden. 

Unsere erste Aufgabe lag darin die Daten aus den *.h5 Dateien in die HBase Datenbank zu importieren.
Dafür verwenden wir Java Bibliothek "ncsa.hdf.object.h5". Mit Hilfe dieser Bibliothek können wir auf die Daten innerhalb der H5 Datei zugreifen.

Für die Daten haben wir in der HBase DB eine Tabelle "Music" angelegt. Bei der Analyse der Struktur für die Tabelle fiel uns auf, dass wir für unsere UseCases nicht alle Spalten brauchen würden. Deswegen haben wir nur zwei Spaltenfamilien erstellt ("song" und "miscellaneous"). In der Spaltenfamilie "song" haben wir Spalten erstellt, um die Suche nach den Daten zu vereinfachen. In der Spaltenfamilie "miscellaneous" haben wir eine große Spalte erstellt, die alle restlichen Daten beinhaltet. Die einzelnen Daten sind durch Semicolon voneinander getrennt. Dadurch ist es an dieser Stelle die Aufgabe des Softwareentwicklers die Daten auseinander zu parsen.
Nachdem die Tabelle mit den entsprechenden Spalten erstellt worden war, konnten wir die Daten aus den .h5 Dateien mit Hilfe unseres Java Programms direkt in HBase importieren.

Im folgenden zeigen wir ein paar Codefragmente zu unserem Datenimport:

Zuerst erfolgt das Lesen der Daten aus einer .h5 Datei:

Man erstellt die Verbindung zu einer h5 Datei.
\begin{lstlisting}[language=Java]
H5File h5File = new H5File(filename, H5File.READ)
\end{lstlisting}

Mit dem Wissen über die Struktur der Daten innerhalb der h5 Datei kann man auf die einzelnen Werte zugreifen. Dies zeigen wir anhand des Beispiels für den Zugriff auf den Wert "analysis_sample_rate" in der Tabelle "/analysis/songs".

\begin{lstlisting}[language=Java]
        H5CompoundDS analysis = (H5CompoundDS) h5File.get("/analysis/songs");
        analysis.init();
        int wantedMember = find( analysis.getMemberNames() , "analysis_sample_rate");
        assert(wantedMember >= 0);
        Vector alldata = (Vector) analysis.getData();
        int[] col = (int[]) alldata.get(wantedMember);
        return col[songidx];
\end{lstlisting}

Im folgenden wird die Vorgehensweise für das Schreiben in die HBase Datenbank gezeigt.
Zuerst muss eine Connection zur HBase DB aufgebauet werden:

\begin{lstlisting}[language=Java]
Configuration config = HBaseConfiguration.create();
            config.setInt("timeout", 120000);
            config.set("hbase.master", "*10.20.110.61:16006*");
            config.set("hbase.zookeeper.quorum","10.20.110.61");
            config.set("hbase.zookeeper.property.clientPort", "2186");
	   Connection connection = ConnectionFactory.createConnection(config);
\end{lstlisting}

Die HBase DB ist von der Applikation über den Port 16006 und der IP Adresse 10.20.110.61 erreichbar.
Darüber hinaus braucht die Applikation die Verbindung zum Zookeeper um auf die einzelnen ClientNodes zuzugreifen.

Nachdem die DB Verbindung hergestellt wurde, kann man auf die Tabellen innerhalb der Datenbank zugreifen:

\begin{lstlisting}[language=Java]
Table table = connection.getTable(TableName.valueOf("music"));
\end{lstlisting}

Eine Datenreihe erzeugt man mit dem Put-Object:

\begin{lstlisting}[language=Java]
Put p = new Put(Bytes.toBytes("Song1"));
/*Erzeugen ein Datensatz mit dem RowKey = "Song11''*/
\\p.addColumn(Bytes.toBytes("song"), Bytes.toBytes("Title"),Bytes.toBytes("HISTORY"));
/*Erzeuge für diesen RowKey in der Spaltenfamilie "song", Spalte: "Title" den Wert "HISTORY"*/
\\table.put(p);
\end{lstlisting}

Mit den oben beschriebenen Codefragmenten war es für uns möglich die Daten zu den Interpretern und dazugehörenden Liedern in die Datenbank zu übertragen.

