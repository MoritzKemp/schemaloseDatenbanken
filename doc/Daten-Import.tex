%\usepackage{listings}
\subsubsection{Import der Daten}
Um die Verwendung von der NoSQL Datenbank HBase und das Programmiermodel MapReduce zu demonstrieren greifen wir auf die frei verfügbare Liste der Daten zu, die millionen Datensätze zu den unterschiedlichen Liedern enthält. Die Datensätze werden von dem Anbieter http://labrosa.ee.columbia.edu/millionsong/pages/getting-dataset bereitgestellt und  sind in dem Verzeichnis "/data/team6/MillionSongSubset/data" in den *.h5 Dateien zu finden. 

Unsere erste Aufgabe lag darin die Daten aus den *.h5 Dateien in die HBase Datenbank zu importieren.
Dafür verwenden wir Java Bibliothek "ncsa.hdf.object.h5". Mit Hilfe dieser Bibliothek können wir auf die Daten innerhalb der H5 Datei zugreifen.

Für die Daten haben wir in der HBase DB eine Tabelle "Music" angelegt. Bei der Analyse der Struktur für die Tabelle fiel uns auf, dass wir für unsere UseCases nicht alle Spalten brauchen würden. Deswegen haben wir zwei Spaltenfamilien angelegt ("song" und "miscellaneous"). In der Spaltenfamilie "song" haben wir für jeden Wert eine Spalten erstellt, um die Suche nach den Daten zu vereinfachen. In der Spaltenfamilie "miscellaneous" haben wir eine große Spalte erstellt, die alle restlichen Daten beinhaltet, die für unsere UseCases nicht relevant sind. Diese irrelevante Daten werden aus der h5 Datei ausgelesen und als ein konkatiniertes String in der Spaltenfamilie miscellaneous gespeichert. Dabei sind die einzelnen Daten durch Semicolon voneinander getrennt. Dadurch ist es an dieser Stelle die Aufgabe eines Softwareentwicklers die Daten bei der Implementierung der Applikation auseinander zu parsen.\\
Nachdem die Tabelle mit den entsprechenden Spalten erstellt worden war, konnten wir die Daten aus den .h5 Dateien mit Hilfe unseres Java Programms direkt in HBase importieren.

Im folgenden zeigen wir ein paar Codefragmente zu unserem Datenimport:

Zuerst erfolgt das Lesen der Daten aus einer .h5 Datei:

Man erstellt die Verbindung zu einer h5 Datei.
\begin{lstlisting}[language=Java]
H5File h5File = new H5File(filename, H5File.READ)
\end{lstlisting}

Mit dem Wissen über die Struktur der Daten innerhalb der h5 Datei kann man auf die einzelnen Werte zugreifen. Dies wird anhand des Beispiels für den Zugriff auf den Wert "analysis_sample_rate" in der Tabelle "/analysis/songs" gezeigt.

\begin{lstlisting}[language=Java]
public int getSampleRate(H5File h5File){
        H5CompoundDS analysis = (H5CompoundDS) h5File.get("/analysis/songs");
        analysis.init();
        int wantedMember = find( analysis.getMemberNames() , "analysis_sample_rate");
        assert(wantedMember >= 0);
        Vector alldata = (Vector) analysis.getData();
        int[] col = (int[]) alldata.get(wantedMember);
        return col[songidx];
}
\end{lstlisting}

Im folgenden wird die Vorgehensweise für das Schreiben in die HBase Datenbank gezeigt. Wie die Verbindung zur HBase erstellt wird und was dabei zu beachten ist, wird in dem Kapitel 4.2.5 Schnittstelle der Anwendung zur Datenbank beschrieben.

Nachdem man den Zufriff zur Tabelle hergestellt hat, kann man verschiedene Operationen ausführen.
Im folgenden wird das Hinzufügen eines neuen Datensatzes beschrieben.
Eine Datenreihe erzeugt man mit dem Put-Object:

\begin{lstlisting}[language=Java]
Put p = new Put(Bytes.toBytes("Song1")); // Erzeugen ein Datensatz mit dem RowKey = "Song1''
p.addColumn(Bytes.toBytes("song"), Bytes.toBytes("Title"),Bytes.toBytes("HISTORY")); //Erzeuge für diesen RowKey in der Spaltenfamilie "song", Spalte: "Title" den Wert "HISTORY"
table.put(p);
\end{lstlisting}

Defaultmäßig wird jeder PUT Operation an die Datenbank sofort geschickt. Wenn man eine große Menge an Daten hat, die in die Datenbank eingetragen werden muss, dann ist es aus den Performance Gründen sehr ratsam AutoFlash auszuschalten. \\
Das erreicht man wie im folgenden Codesnippet gezeigt wird:
\begin{lstlisting}[language=Java]
htable.setAutoFlush(true);
\end{lstlisting}
Dabei werden die Daten nur dann an die Datenbank übertragen, wenn der Writebuffer voll ist. Die Größe eines Writebuffer ist per Default 2MB. 

Mit der Hilfe der obenbeschriebenen Schnittstellen auf die h5 Dateien und die HBase Datenbank wurde von uns der Datenimport implementiert.

